name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # Use ccache to speed up builds
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  # ============================================================================
  # Format and Lint Checks
  # ============================================================================
  format-lint:
    name: Code Style Check
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format and clang-tidy
        run: sudo apt-get update && sudo apt-get install -y clang-format clang-tidy

      - name: Check formatting
        run: |
          find . -name '*.hpp' -o -name '*.cpp' | xargs clang-format --dry-run --Werror

  clang-tidy:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build clang-18 clang-tidy-18

      - name: Configure CMake
        run: cmake --preset serial-clang-18 -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build for analysis
        run: cmake --build --preset serial-clang-18

      - name: Run clang-tidy
        run: run-clang-tidy-18 -p build-serial-clang-18 tests/ benchmarks/ src/ --warnings-as-errors

  # ============================================================================
  # Compiler Matrix Tests
  # ============================================================================
  # Serial Backend
  serial-gcc-12:
    name: Serial (GCC 12)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache g++-12

      # Cache ccache compilation cache
      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-serial-gcc-12-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-serial-gcc-12-

      # Cache FetchContent dependencies (Kokkos, GoogleTest, Google Benchmark)
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            build-serial-gcc-12/_deps
            ~/.cache/ccache
          key: deps-serial-gcc-12-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-serial-gcc-12-

      - name: Configure CMake
        run: cmake --preset serial-gcc-12

      - name: Build
        run: cmake --build --preset serial-gcc-12 -- -j$(nproc)

      - name: Run tests
        run: ctest --preset serial-gcc-12 --output-on-failure

      - name: Show ccache statistics
        run: ccache -s || true

  serial-gcc-14:
    name: Serial (GCC 14)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache g++-14

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-serial-gcc-14-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-serial-gcc-14-

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            build-serial-gcc-14/_deps
            ~/.cache/ccache
          key: deps-serial-gcc-14-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-serial-gcc-14-

      - name: Configure CMake
        run: cmake --preset serial-gcc-14

      - name: Build
        run: cmake --build --preset serial-gcc-14 -- -j$(nproc)

      - name: Run tests
        run: ctest --preset serial-gcc-14 --output-on-failure

      - name: Show ccache statistics
        run: ccache -s || true

  serial-clang-18:
    name: Serial (Clang 18)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache clang-18

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-serial-clang-18-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-serial-clang-18-

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            build-serial-clang-18/_deps
            ~/.cache/ccache
          key: deps-serial-clang-18-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-serial-clang-18-

      - name: Configure CMake
        run: cmake --preset serial-clang-18

      - name: Build
        run: cmake --build --preset serial-clang-18 -- -j$(nproc)

      - name: Run tests
        run: ctest --preset serial-clang-18 --output-on-failure

      - name: Show ccache statistics
        run: ccache -s || true

  # OpenMP Backend
  openmp-gcc-12:
    name: OpenMP (GCC 12)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache g++-12

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-openmp-gcc-12-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-openmp-gcc-12-

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            build-openmp-gcc-12/_deps
            ~/.cache/ccache
          key: deps-openmp-gcc-12-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-openmp-gcc-12-

      - name: Configure CMake
        run: cmake --preset openmp-gcc-12

      - name: Build
        run: cmake --build --preset openmp-gcc-12 -- -j$(nproc)

      - name: Run tests
        run: ctest --preset openmp-gcc-12 --output-on-failure

      - name: Show ccache statistics
        run: ccache -s || true

  openmp-gcc-14:
    name: OpenMP (GCC 14)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache g++-14

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-openmp-gcc-14-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-openmp-gcc-14-

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            build-openmp-gcc-14/_deps
            ~/.cache/ccache
          key: deps-openmp-gcc-14-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-openmp-gcc-14-

      - name: Configure CMake
        run: cmake --preset openmp-gcc-14

      - name: Build
        run: cmake --build --preset openmp-gcc-14 -- -j$(nproc)

      - name: Run tests
        run: ctest --preset openmp-gcc-14 --output-on-failure

      - name: Show ccache statistics
        run: ccache -s || true

  # Note: OpenMP with Clang has issues with CMake detection in some environments
  # The presets are available for local use but not tested in CI
  # To use locally, you may need: -DOpenMP_CXX_FLAGS="-fopenmp=libomp" -DOpenMP_CXX_LIB_NAMES=omp
  # openmp-clang-18:

  # ============================================================================
  # Sanitizers
  # ============================================================================
  serial-sanitizer:
    name: Serial (ASAN/UBSAN with GCC 14)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build g++-14

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-serial-asan-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-serial-asan-

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            build-serial-asan/_deps
            ~/.cache/ccache
          key: deps-serial-asan-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-serial-asan-

      - name: Configure CMake
        run: cmake --preset serial-asan -DCMAKE_CXX_COMPILER=g++-14

      - name: Build
        run: cmake --build --preset serial-asan -- -j$(nproc)

      - name: Run tests
        run: ctest --preset serial-asan --output-on-failure

      - name: Show ccache statistics
        run: ccache -s || true

  # ============================================================================
  # Benchmarks (only on GCC 14 + OpenMP for regression detection)
  # ============================================================================
  openmp-benchmarks:
    name: OpenMP Benchmarks (GCC 14)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache g++-14

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-openmp-gcc-14-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-openmp-gcc-14-

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            build-openmp-gcc-14/_deps
            ~/.cache/ccache
          key: deps-openmp-gcc-14-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-openmp-gcc-14-

      - name: Configure CMake
        run: cmake --preset openmp-gcc-14

      - name: Build
        run: cmake --build --preset openmp-gcc-14 -- -j$(nproc)

      - name: Run benchmarks
        run: ./build-openmp-gcc-14/benchmarks/subsetix_benchmark_main --benchmark_min_time=0.1

      - name: Show ccache statistics
        run: ccache -s || true

  # ============================================================================
  # Code Coverage
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build g++-14 lcov

      - name: Configure CMake with coverage
        run: >
          cmake --preset serial-gcc-14
          -DCMAKE_CXX_FLAGS="--coverage"
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

      - name: Build
        run: cmake --build --preset serial-gcc-14 -- -j$(nproc)

      - name: Run tests
        run: ctest --preset serial-gcc-14 --output-on-failure

      - name: Generate coverage report
        run: |
          lcov --capture --directory build-serial-gcc-14 --output-file coverage.info --no-external
          lcov --list coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --remove coverage.info '*/_deps/*' --output-file coverage.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
