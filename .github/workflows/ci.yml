name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # Use ccache to speed up builds
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  # ============================================================================
  # Format and Lint Checks
  # ============================================================================
  format-lint:
    name: Code Style Check
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Install clang-format and clang-tidy
        run: sudo apt-get update && sudo apt-get install -y clang-format clang-tidy

      - name: Check formatting
        run: |
          find . -name '*.hpp' -o -name '*.cpp' | xargs clang-format --dry-run --Werror

  clang-tidy:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build clang-18 clang-tidy-18

      - name: Configure CMake
        run: cmake --preset serial-clang-18 -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build for analysis
        run: cmake --build --preset serial-clang-18

      - name: Run clang-tidy
        run: run-clang-tidy-18 -p build-serial-clang-18 tests/ benchmarks/ src/ -warnings-as-errors '*' -header-filter='^subsetix/' -quiet

  # ============================================================================
  # Compiler Matrix Tests
  # ============================================================================
  # Test matrix: compiler x backend
  # serial-clang tests the default clang preset (issue #17 fix)
  test:
    name: Test (${{ matrix.backend }}, ${{ matrix.compiler }})
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          # Serial backend
          - backend: serial
            preset: serial-gcc-12
            compiler: gcc-12
            cc: gcc-12
            cxx: g++-12
          - backend: serial
            preset: serial-gcc-14
            compiler: gcc-14
            cc: gcc-14
            cxx: g++-14
          - backend: serial
            preset: serial-clang
            compiler: clang
            cc: clang
            cxx: clang++
          - backend: serial
            preset: serial-clang-18
            compiler: clang-18
            cc: clang-18
            cxx: clang++-18
          # OpenMP backend
          - backend: openmp
            preset: openmp-gcc-12
            compiler: gcc-12
            cc: gcc-12
            cxx: g++-12
          - backend: openmp
            preset: openmp-gcc-14
            compiler: gcc-14
            cc: gcc-14
            cxx: g++-14
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache ${{ matrix.cc }}

      - name: Setup ccache
        uses: actions/cache@v5
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-${{ matrix.preset }}-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-${{ matrix.preset }}-

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: build-${{ matrix.preset }}/_deps
          key: deps-${{ matrix.preset }}-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-${{ matrix.preset }}-

      - name: Configure CMake
        run: cmake --preset ${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset ${{ matrix.preset }} -- -j$(nproc)

      - name: Run tests
        run: ctest --preset ${{ matrix.preset }} --output-on-failure

      - name: Show ccache statistics
        run: ccache -s || true

  # ============================================================================
  # Benchmarks (run once, reuse openmp-gcc-14 build)
  # ============================================================================
  # Note: This reuses the test build cache for openmp-gcc-14 (fixes issue #18)
  benchmark:
    name: Benchmark (OpenMP, GCC 14)
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    needs: test  # Run after tests to reuse cache
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build ccache g++-14

      - name: Setup ccache
        uses: actions/cache@v5
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-openmp-gcc-14-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-openmp-gcc-14-

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: build-openmp-gcc-14/_deps
          key: deps-openmp-gcc-14-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-openmp-gcc-14-

      - name: Configure CMake
        run: cmake --preset openmp-gcc-14

      - name: Build
        run: cmake --build --preset openmp-gcc-14 -- -j$(nproc)

      - name: Run benchmarks
        run: ./build-openmp-gcc-14/benchmarks/subsetix_benchmark_main --benchmark_min_time=0.1

      - name: Show ccache statistics
        run: ccache -s || true

  # ============================================================================
  # Sanitizers
  # ============================================================================
  sanitizers:
    name: Sanitizers (ASAN/UBSAN, GCC 14)
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build g++-14

      - name: Setup ccache
        uses: actions/cache@v5
        with:
          path: .ccache
          key: v1-ccache-${{ runner.os }}-serial-asan-${{ hashFiles('CMakeLists.txt', 'src/CMakeLists.txt') }}
          restore-keys: |
            v1-ccache-${{ runner.os }}-serial-asan-

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: build-serial-asan/_deps
          key: deps-serial-asan-${{ hashFiles('CMakeLists.txt', '**/CMakeLists.txt') }}
          restore-keys: |
            deps-serial-asan-

      - name: Configure CMake
        run: cmake --preset serial-asan -DCMAKE_CXX_COMPILER=g++-14

      - name: Build
        run: cmake --build --preset serial-asan -- -j$(nproc)

      - name: Run tests
        run: ctest --preset serial-asan --output-on-failure

      - name: Show ccache statistics
        run: ccache -s || true

  # ============================================================================
  # Code Coverage
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y ninja-build g++-14 lcov

      - name: Configure CMake with coverage
        run: >
          cmake --preset serial-gcc-14
          -DCMAKE_CXX_FLAGS="--coverage"
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

      - name: Build
        run: cmake --build --preset serial-gcc-14 -- -j$(nproc)

      - name: Run tests
        run: ctest --preset serial-gcc-14 --output-on-failure

      - name: Generate coverage report
        run: |
          lcov --capture --directory build-serial-gcc-14 --output-file coverage.info --no-external --gcov-tool gcov-14
          lcov --remove coverage.info '*/_deps/*' --output-file coverage.info --gcov-tool gcov-14
          lcov --list coverage.info --gcov-tool gcov-14

      - name: Check coverage threshold (quality gate)
        run: |
          echo "Checking coverage quality gate..."
          LINE_COV=$(lcov --summary coverage.info 2>&1 | grep "lines" | grep -oP '\d+\.\d+(?=%)' || echo "0.0")
          echo "Line coverage: ${LINE_COV}%"

          MIN_COVERAGE=60.0
          if (( $(echo "$LINE_COV < $MIN_COVERAGE" | bc -l) )); then
            echo "::error::Coverage ${LINE_COV}% is below minimum ${MIN_COVERAGE}%"
            exit 1
          fi
          echo "::notice::Coverage ${LINE_COV}% meets minimum ${MIN_COVERAGE}% threshold"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
